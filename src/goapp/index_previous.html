<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“Š ç™¾åˆ†æ¯”å›¾è¡¨ï¼ˆIMG é™æ€å›¾ï¼‰</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
    .control-group { margin: 15px 0; }
    label { display: inline-block; width: 120px; }
    input, button { padding: 8px 12px; margin: 4px; }
    
    button {
      background: #007bff; color: white; border: none; border-radius: 4px;
      cursor: pointer; transition: all 0.2s;
    }
    button:hover:not(:disabled) { background: #0056b3; }
    button.btn-delete {
      background: #dc3545;
    }
    button.btn-delete:hover:not(:disabled) {
      background: #c82333;
    }

    .btn-group {
      display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;
    }
    @media (max-width: 768px) {
      .btn-group { flex-direction: column; }
      button { width: 100%; }
    }

    .img-container {
      margin: 20px 0; padding: 10px; border: 1px solid #eee; border-radius: 4px;
    }
    .img-container img {
      max-width: 100%; height: auto; display: block; margin: 10px auto;
    }
    .loading {
      color: #666; font-style: italic;
    }
    .message {
      font-size: 1.2em; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff;
      margin-bottom: 10px; border-radius: 4px;
    }
    pre {
      background: #f1f1f1;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
      margin-top: 10px;
      border: 1px solid #ddd;
    }
    .image-item {
      margin: 12px 0;
    }
    .image-item img {
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .copy-button {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>ğŸ“ˆ ç™¾åˆ†æ¯”è¶‹åŠ¿å›¾ï¼ˆIMG é™æ€å›¾ï¼‰</h1>

  <div class="control-group">
    <label>GraphID:</label>
    <input type="number" id="graphID" value="985" min="1" />
    <br>
    <label>Percent (%):</label>
    <input type="text" id="percent" value="95" />
    <br>
    <label>MonthAgo:</label>
    <input type="number" id="monthAgo" value="1" min="1" />
    <br>
    <label>æ˜¯å¦ç”Ÿæˆå›¾ç‰‡?</label>
    <input type="checkbox" id="isDown" />
    <br><br>

    <!-- ä½¿ç”¨ btn-group åŒ…è£¹æ‰€æœ‰æŒ‰é’® -->
    <div class="btn-group">
      <button id="btnEveryday">ğŸ“† è·å–æ¯æ—¥æ•°æ®</button>
      <button id="btnMonthly">ğŸ“… è·å–æœˆåº¦æ•°æ®</button>
      <button id="btnDescribeImage">ğŸ–¼ï¸ å±•ç¤ºå›¾ç‰‡</button>
      <button id="btnDeleteDir" class="btn-delete">ğŸ—‘ï¸ æ¸…ç©º img ç›®å½•</button>
    </div>
  </div>

  <!-- æ¥å£è¿”å›æ•°æ®åŒº -->
  <div class="img-container">
    <h3>ğŸ” æ¥å£è¿”å›æ•°æ®ï¼š</h3>
    <div id="message" class="message">è¯·å…ˆç‚¹å‡»ä¸Šæ–¹æŒ‰é’®</div>
    <pre id="dataMatrix"></pre>
    <button class="copy-button" onclick="copyMatrix()">å¤åˆ¶çŸ©é˜µ</button>
  </div>

  <!-- å›¾ç‰‡å±•ç¤ºåŒº -->
  <div class="img-container">
    <h3>ğŸ–¼ï¸ å›¾ç‰‡å±•ç¤ºï¼š</h3>
    <div id="imgPreview" class="loading">ç­‰å¾…åŠ è½½...</div>
  </div>

  <script>
    const messageEl = document.getElementById('message');
    const previewEl = document.getElementById('imgPreview');
    const dataMatrixEl = document.getElementById('dataMatrix');

    function showLoading() {
      messageEl.textContent = "â³ æ­£åœ¨è¯·æ±‚...";
      messageEl.style.backgroundColor = "#fff3cd";
      messageEl.style.borderLeftColor = "#ffc107";
      previewEl.innerHTML = '<div class="loading">ğŸ”„ åŠ è½½ä¸­...</div>';
    }

    function showError(msg) {
      messageEl.textContent = "âŒ " + msg;
      messageEl.style.backgroundColor = "#f8d7da";
      messageEl.style.borderLeftColor = "#dc3545";
      previewEl.innerHTML = '';
    }

    function showResult(data) {
      if (data.success && data.data) {
        // æ˜¾ç¤ºæœåŠ¡å™¨æ¶ˆæ¯
        messageEl.textContent = data.data.message || 'âœ… è¯·æ±‚æˆåŠŸ';
        messageEl.style.backgroundColor = "#d1ecf1";
        messageEl.style.borderLeftColor = "#007bff";

        const images = data.data.images;
        if (images && Array.isArray(images) && images.length > 0) {
          let html = '';

          // æå–åŸºç¡€ URL å¹¶å»é™¤æœ«å°¾æ–œæ 
          const baseImageUrl = (data.data.url || '').replace(/\/+$/, '');

          images.forEach(img => {
            let finalUrl = img.url;

            // å¦‚æœä¸æ˜¯å®Œæ•´é“¾æ¥ï¼Œåˆ™æ‹¼æ¥ baseImageUrl
            if (!finalUrl.startsWith('http')) {
              finalUrl = `${baseImageUrl}/${finalUrl.replace(/^\//, '')}`;
            }

            html += `
              <div class="image-item">
                <img src="${finalUrl}" alt="${img.name}"
                     onerror="this.outerHTML='<small style=color:red;font-weight:bold;'>âš ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥ï¼š<br/>${finalUrl}</small>'">
                <br><small><strong>${img.name || 'æœªçŸ¥å›¾è¡¨'}</strong></small>
              </div>
            `;
          });

          previewEl.innerHTML = html;
        } else {
          previewEl.innerHTML = '<p>ğŸ“· æœªç”Ÿæˆä»»ä½•å›¾ç‰‡ã€‚</p>';
        }
      } else {
        showError("è¯·æ±‚å¤±è´¥ï¼š" + (data.message || 'æœªçŸ¥é”™è¯¯'));
      }
    }

    function callAPI(endpoint) {
      showLoading();
      const graphID = parseInt(document.getElementById('graphID').value) || 123;
      const percent = document.getElementById('percent').value || '95';
      const monthAgo = parseInt(document.getElementById('monthAgo').value) || 1;
      const isDown = document.getElementById('isDown').checked;

      const url = new URL(`/api/cacti/${endpoint}`, window.location.origin);
      url.searchParams.set('GraphID', graphID);
      url.searchParams.set('Percent', percent);
      url.searchParams.set('MonthAgo', monthAgo);
      url.searchParams.set('IsDown', isDown);

      fetch(url)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(data => {
          // æ¸…ç©ºå›¾ç‰‡åŒºåŸŸï¼ˆé¿å…æ®‹ç•™æ—§å›¾ï¼‰
          previewEl.innerHTML = '';

          // æå– Values å¹¶æ¸²æŸ“ä¸ºè¡¨æ ¼ï¼ˆä»…å½“å­˜åœ¨ä¸”ä¸ºæ•°ç»„ï¼‰
          const values = data.data?.Values;
          if (Array.isArray(values) && values.length > 0) {
            let matrixText = `Data\tValue\n`;
            values.forEach(item => {
              matrixText += `${item.Data}\t${Number(item.Value).toFixed(1)}\n`;
            });

            dataMatrixEl.textContent = matrixText;
          } else {
            dataMatrixEl.textContent = 'âš ï¸ æœªè·å–åˆ°æœ‰æ•ˆæ•°å€¼æ•°æ®ï¼ˆValues ä¸ºç©ºæˆ–æ ¼å¼å¼‚å¸¸ï¼‰';
          }

          // æ›´æ–°é¡¶éƒ¨æç¤ºæ 
          messageEl.textContent = data.message || data.data?.message || 'âœ… è¯·æ±‚æˆåŠŸ';
          messageEl.style.backgroundColor = "#d1ecf1";
          messageEl.style.borderLeftColor = "#007bff";
        })
        .catch(err => {
          console.error('[API]', err);
          showError("ç½‘ç»œé”™è¯¯ï¼š" + (err.message || 'è¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€'));
          dataMatrixEl.textContent = 'âŒ è¯·æ±‚å‡ºé”™ï¼š' + err.message;
        });
    }

    function DescribeImage() {
      showLoading();
      const graphID = parseInt(document.getElementById('graphID').value) || 123;

      const url = new URL('/api/cacti/DescribeImage', window.location.origin);
      url.searchParams.set('GraphID', graphID);

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 60_000);

      fetch(url, { signal: controller.signal })
        .then(res => {
          clearTimeout(timeoutId);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(showResult)
        .catch(err => {
          clearTimeout(timeoutId);
          if (err.name === 'AbortError') {
            showError("â° è¯·æ±‚è¶…æ—¶ï¼ˆ60ç§’ï¼‰ï¼Œè¯·ç¡®è®¤å›¾ç‰‡å·²ç”Ÿæˆæˆ–æœåŠ¡æ­£å¸¸è¿è¡Œã€‚");
          } else {
            console.error('[DescribeImage]', err);
            showError("è¯·æ±‚å¤±è´¥ï¼š" + err.message);
          }
        });
    }

    function DeleteDir() {
      if (!confirm('âš ï¸ ç¡®è®¤æ¸…ç©º img/ ç›®å½•ï¼Ÿ\nâš ï¸ æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•å°†è¢«æ°¸ä¹…åˆ é™¤ï¼\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;

      showLoading();
      const url = new URL('/api/cacti/DeleteDir', window.location.origin);
      url.searchParams.set('Dir', 'img');

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30_000); // 30ç§’è¶…æ—¶

      fetch(url, { signal: controller.signal })
        .then(res => {
          clearTimeout(timeoutId);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(data => {
          if (data.success) {
            messageEl.textContent = "âœ… å·²æˆåŠŸæ¸…ç©º img/ ç›®å½•";
            messageEl.style.backgroundColor = "#d1ecf1";
            messageEl.style.borderLeftColor = "#007bff";
            previewEl.innerHTML = '<p>ğŸ—‚ï¸ ç›®å½•å·²æ¸…ç©ºã€‚</p>';
          } else {
            throw new Error(data.message || 'æ¸…ç©ºå¤±è´¥');
          }
        })
        .catch(err => {
          clearTimeout(timeoutId);
          if (err.name === 'AbortError') {
            showError("â° æ“ä½œè¶…æ—¶ï¼ˆ30ç§’ï¼‰");
          } else {
            showError("âŒ åˆ é™¤å¤±è´¥ï¼š" + err.message);
          }
        });
    }

    function copyMatrix() {
      navigator.clipboard.writeText(dataMatrixEl.textContent).then(function() {
        alert("çŸ©é˜µæ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
      }, function(err) {
        console.error('Async: Could not copy text: ', err);
      });
    }

    document.getElementById('btnEveryday').onclick = () => callAPI('GetPercentEveryDay');
    document.getElementById('btnMonthly').onclick = () => callAPI('GetPercentMonthly');
    document.getElementById('btnDescribeImage').onclick = DescribeImage;
    document.getElementById('btnDeleteDir').onclick = DeleteDir;
  </script>
</body>
</html>