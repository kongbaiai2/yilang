<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“Š ç™¾åˆ†æ¯”å›¾è¡¨ï¼ˆIMG é™æ€å›¾ï¼‰</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
    .control-group { margin: 15px 0; }
    label { display: inline-block; width: 120px; }
    input, button { padding: 8px 12px; margin: 4px; }
    
    button {
      background: #007bff; color: white; border: none; border-radius: 4px;
      cursor: pointer; transition: all 0.2s;
    }
    button:hover:not(:disabled) { background: #0056b3; }
    button.btn-delete {
      background: #dc3545;
    }
    button.btn-delete:hover:not(:disabled) {
      background: #c82333;
    }

    .btn-group {
      display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;
    }
    @media (max-width: 768px) {
      .btn-group { flex-direction: column; }
      button { width: 100%; }
    }

    .img-container {
      margin: 20px 0; padding: 10px; border: 1px solid #eee; border-radius: 4px;
    }
    .img-container img {
      max-width: 100%; height: auto; display: block; margin: 10px auto;
    }
    .loading {
      color: #666; font-style: italic;
    }
    .message {
      font-size: 1.2em; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff;
      margin-bottom: 10px; border-radius: 4px;
    }
    pre {
      background: #f1f1f1;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
      margin-top: 10px;
      border: 1px solid #ddd;
    }
    .image-item {
      margin: 12px 0;
    }
    .image-item img {
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .copy-button {
      margin-top: 10px;
      padding: 8px 16px;
      font-weight: bold;
      background: #28a745;
      border-color: #218838;
    }
    .copy-button:hover:not(:disabled) {
      background: #218838;
    }
  </style>
</head>
<body>
  <h1>ğŸ“ˆ ç™¾åˆ†æ¯”è¶‹åŠ¿å›¾ </h1> tx: 889<p>youyuan: 1166<p>xiantong: 1091<p></p>
 

  <div class="control-group">
    <label>GraphID:</label>
    <input type="number" id="graphID" value="889" min="1" />
    <br>
    <label>Percent (%):</label>
    <input type="text" id="percent" value="95" />
    <br>
    <label>MonthAgo:</label>
    <input type="number" id="monthAgo" value="1" min="1" />
    <br>
    <label>æ˜¯å¦ç”Ÿæˆå›¾ç‰‡?</label>
    <input type="checkbox" id="isDown" />
    <br><br>

    <!-- ä½¿ç”¨ btn-group åŒ…è£¹æ‰€æœ‰æŒ‰é’® -->
    <div class="btn-group">
      <button id="btnEveryday">ğŸ“† è·å–æ¯æ—¥æ•°æ®</button>
      <button id="btnMonthly">ğŸ“… è·å–æœˆåº¦æ•°æ®</button>
      <button id="btnDescribeImage">ğŸ–¼ï¸ å±•ç¤ºå›¾ç‰‡</button>
      <button id="btnDeleteDir" class="btn-delete">ğŸ—‘ï¸ æ¸…ç©º img ç›®å½•</button>
    </div>
  </div>

  <!-- æ¥å£è¿”å›æ•°æ®åŒº -->
  <div class="img-container">
    <h3>ğŸ” æ¥å£è¿”å›æ•°æ®ï¼š</h3>
    <div id="message" class="message">è¯·å…ˆç‚¹å‡»ä¸Šæ–¹æŒ‰é’®</div>
    <pre id="dataMatrix">ğŸ‘‰ ç‚¹å‡» [è·å–æ¯æ—¥/æœˆåº¦æ•°æ®] æŸ¥çœ‹äºŒç»´çŸ©é˜µï¼ˆData\tValueï¼‰</pre>
    <button class="copy-button" onclick="copyMatrix()">ğŸ“‹ å¤åˆ¶çŸ©é˜µï¼ˆCtrl+Cï¼‰</button>
  </div>

  <!-- å›¾ç‰‡å±•ç¤ºåŒº -->
  <div class="img-container">
    <h3>ğŸ–¼ï¸ å›¾ç‰‡å±•ç¤ºï¼š</h3>
    <div id="imgPreview" class="loading">ç­‰å¾…åŠ è½½...</div>
  </div>

  <script>
    const messageEl = document.getElementById('message');
    const previewEl = document.getElementById('imgPreview');
    const dataMatrixEl = document.getElementById('dataMatrix');

    function showLoading() {
      messageEl.textContent = "â³ æ­£åœ¨è¯·æ±‚...";
      messageEl.style.backgroundColor = "#fff3cd";
      messageEl.style.borderLeftColor = "#ffc107";
      previewEl.innerHTML = '<div class="loading">ğŸ”„ åŠ è½½ä¸­...</div>';
    }

    function showError(msg) {
      messageEl.textContent = "âŒ " + msg;
      messageEl.style.backgroundColor = "#f8d7da";
      messageEl.style.borderLeftColor = "#dc3545";
      previewEl.innerHTML = '';
    }

    function showResult(data) {
      if (data.success && data.data) {
        messageEl.textContent = data.data.message || 'âœ… è¯·æ±‚æˆåŠŸ';
        messageEl.style.backgroundColor = "#d1ecf1";
        messageEl.style.borderLeftColor = "#007bff";

        const images = data.data.images;
        if (images && Array.isArray(images) && images.length > 0) {
          let html = '';
          const baseImageUrl = (data.data.url || '').replace(/\/+$/, '');

          images.forEach(img => {
            let finalUrl = img.url;
            if (!finalUrl.startsWith('http')) {
              finalUrl = `${baseImageUrl}/${finalUrl.replace(/^\//, '')}`;
            }
            html += `
              <div class="image-item">
                <img src="${finalUrl}" alt="${img.name}"
                     onerror="this.outerHTML='<small style=color:red;font-weight:bold;'>âš ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥ï¼š<br/>${finalUrl}</small>'">
                <br><small><strong>${img.name || 'æœªçŸ¥å›¾è¡¨'}</strong></small>
              </div>
            `;
          });
          previewEl.innerHTML = html;
        } else {
          previewEl.innerHTML = '<p>ğŸ“· æœªç”Ÿæˆä»»ä½•å›¾ç‰‡ã€‚</p>';
        }
      } else {
        showError("è¯·æ±‚å¤±è´¥ï¼š" + (data.message || 'æœªçŸ¥é”™è¯¯'));
      }
    }

    function callAPI(endpoint) {
      showLoading();
      const graphID = parseInt(document.getElementById('graphID').value) || 123;
      const percent = document.getElementById('percent').value || '95';
      const monthAgo = parseInt(document.getElementById('monthAgo').value) || 1;
      const isDown = document.getElementById('isDown').checked;

      const url = new URL(`/api/cacti/${endpoint}`, window.location.origin);
      url.searchParams.set('GraphID', graphID);
      url.searchParams.set('Percent', percent);
      url.searchParams.set('MonthAgo', monthAgo);
      url.searchParams.set('IsDown', isDown);

      fetch(url)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(data => {
          previewEl.innerHTML = ''; // æ¸…ç©ºå›¾ç‰‡åŒº

          const values = data.data?.Values;
          if (Array.isArray(values) && values.length > 0) {
            let matrix = 'Data\tValue\n';
            values.forEach(item => {
              matrix += `${item.Data}\t${Number(item.Value).toFixed(1)}\n`;
            });
            dataMatrixEl.textContent = matrix;
          } else {
            dataMatrixEl.textContent = 'âš ï¸ æœªè·å–åˆ°æœ‰æ•ˆæ•°å€¼æ•°æ®ï¼ˆValues ä¸ºç©ºæˆ–æ ¼å¼å¼‚å¸¸ï¼‰';
          }

          messageEl.textContent = data.message || data.data?.message || 'âœ… è¯·æ±‚æˆåŠŸ';
          messageEl.style.backgroundColor = "#d1ecf1";
          messageEl.style.borderLeftColor = "#007bff";
        })
        .catch(err => {
          console.error('[API]', err);
          showError("ç½‘ç»œé”™è¯¯ï¼š" + (err.message || 'è¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€'));
          dataMatrixEl.textContent = 'âŒ è¯·æ±‚å‡ºé”™ï¼š' + err.message;
        });
    }

    function DescribeImage() {
      showLoading();
      const graphID = parseInt(document.getElementById('graphID').value) || 123;

      const url = new URL('/api/cacti/DescribeImage', window.location.origin);
      url.searchParams.set('GraphID', graphID);

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 60_000);

      fetch(url, { signal: controller.signal })
        .then(res => {
          clearTimeout(timeoutId);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(showResult)
        .catch(err => {
          clearTimeout(timeoutId);
          if (err.name === 'AbortError') {
            showError("â° è¯·æ±‚è¶…æ—¶ï¼ˆ60ç§’ï¼‰ï¼Œè¯·ç¡®è®¤å›¾ç‰‡å·²ç”Ÿæˆæˆ–æœåŠ¡æ­£å¸¸è¿è¡Œã€‚");
          } else {
            console.error('[DescribeImage]', err);
            showError("è¯·æ±‚å¤±è´¥ï¼š" + err.message);
          }
        });
    }

    function DeleteDir() {
      if (!confirm('âš ï¸ ç¡®è®¤æ¸…ç©º img/ ç›®å½•ï¼Ÿ\nâš ï¸ æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•å°†è¢«æ°¸ä¹…åˆ é™¤ï¼\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;

      showLoading();
      const url = new URL('/api/cacti/DeleteDir', window.location.origin);
      url.searchParams.set('Dir', 'img');

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30_000);

      fetch(url, { signal: controller.signal })
        .then(res => {
          clearTimeout(timeoutId);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(data => {
          if (data.success) {
            messageEl.textContent = "âœ… å·²æˆåŠŸæ¸…ç©º img/ ç›®å½•";
            messageEl.style.backgroundColor = "#d1ecf1";
            messageEl.style.borderLeftColor = "#007bff";
            previewEl.innerHTML = '<p>ğŸ—‚ï¸ ç›®å½•å·²æ¸…ç©ºã€‚</p>';
          } else {
            throw new Error(data.message || 'æ¸…ç©ºå¤±è´¥');
          }
        })
        .catch(err => {
          clearTimeout(timeoutId);
          if (err.name === 'AbortError') {
            showError("â° æ“ä½œè¶…æ—¶ï¼ˆ30ç§’ï¼‰");
          } else {
            showError("âŒ åˆ é™¤å¤±è´¥ï¼š" + err.message);
          }
        });
    }

    // âœ… âœ… âœ… å¤åˆ¶å‡½æ•°ï¼ˆå¼ºå…¼å®¹ã€é«˜æˆåŠŸç‡ï¼‰âœ… âœ… âœ…

  // âœ… æ›¿æ¢åŸæœ‰çš„ copyMatrix å‡½æ•°ä¸ºä»¥ä¸‹ç‰ˆæœ¬ï¼ˆä¸“ä¸º HTTP ç¯å¢ƒä¼˜åŒ–ï¼‰
  function copyMatrix() {
    const text = document.getElementById('dataMatrix').textContent;
    if (!text || text.trim() === '') {
      alert('âš ï¸ å½“å‰æ²¡æœ‰æ•°æ®å¯ä»¥å¤åˆ¶ï¼Œè¯·å…ˆç‚¹å‡»ã€è·å–æ¯æ—¥/æœˆåº¦æ•°æ®ã€‘');
      return;
    }

    // åˆ›å»ºä¸´æ—¶ textarea
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0'; // ä¸å¯è§ä½†å¯èšç„¦
    textarea.style.pointerEvents = 'none'; // ä¸å½±å“äº¤äº’
    document.body.appendChild(textarea);

    try {
      textarea.select(); // é€‰ä¸­å†…å®¹
      const result = document.execCommand('copy'); // æ‰§è¡Œå¤åˆ¶å‘½ä»¤

      document.body.removeChild(textarea); // æ¸…ç†

      if (result) {
        // âœ… æˆåŠŸå¤åˆ¶
        alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nç°åœ¨ä½ å¯ä»¥ç²˜è´´åˆ° Excel / è®°äº‹æœ¬ç­‰åœ°æ–¹ã€‚\n\nğŸ“Œ æç¤ºï¼šExcel ä¸­ä¼šè‡ªåŠ¨æŒ‰åˆ—åˆ†å¼€ï¼ˆTabåˆ†éš”ï¼‰');
      } else {
        // âŒ å¤±è´¥ â€”â€” å¼•å¯¼ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
        manualCopyFallback(text);
      }
    } catch (err) {
      document.body.removeChild(textarea);
      console.error('å¤åˆ¶å¤±è´¥:', err);
      manualCopyFallback(text);
    }
  }

  // âœ… æ‰‹åŠ¨å¤åˆ¶å…œåº•æ–¹æ¡ˆ
  function manualCopyFallback(text) {
    const msg = `âŒ è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼ˆå¯èƒ½å› æµè§ˆå™¨é™åˆ¶ï¼‰ã€‚\n\nğŸ‘‰ è¯·æ‰‹åŠ¨æ“ä½œï¼š\n1. æŒ‰ Ctrl+A å…¨é€‰ä¸‹æ–¹å†…å®¹\n2. æŒ‰ Ctrl+C å¤åˆ¶\n3. åˆ° Excel / æ–‡æœ¬ç¼–è¾‘å™¨ä¸­ç²˜è´´\n\n--- æ•°æ®é¢„è§ˆ ---\n${text.substring(0, 200)}...`;
    prompt(msg, text); // ä½¿ç”¨ prompt æ˜¾ç¤ºå…¨éƒ¨å†…å®¹å¹¶å…è®¸å¤åˆ¶
  }


    function fallbackCopy(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed'; // é˜²æ­¢æ»šåŠ¨
      textarea.style.left = '-9999px';
      textarea.style.top = '-9999px';
      document.body.appendChild(textarea);
      textarea.focus();
      textarea.select();

      try {
        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);
        if (successful) {
          alert('âœ… çŸ©é˜µæ•°æ®å·²æˆåŠŸå¤åˆ¶ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰ï¼');
        } else {
          throw new Error('execCommand failed');
        }
      } catch (err) {
        console.error('Fallback copy failed:', err);
        alert('âŒ å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨å…¨é€‰ä¸Šæ–¹å†…å®¹ï¼ˆCtrl+A â†’ Ctrl+Cï¼‰');
      }
    }

    // ğŸ”— ç»‘å®šäº‹ä»¶
    document.getElementById('btnEveryday').onclick = () => callAPI('GetPercentEveryDay');
    document.getElementById('btnMonthly').onclick = () => callAPI('GetPercentMonthly');
    document.getElementById('btnDescribeImage').onclick = DescribeImage;
    document.getElementById('btnDeleteDir').onclick = DeleteDir;
  </script>
</body>
</html>